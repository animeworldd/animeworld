<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–°–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∏–º–µ - AnimeWorld</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="index.html">
                    <h1 data-lang="app.name">üç• AnimeWorld</h1>
                </a>
            </div>
            <button class="burger-btn" id="burgerBtn">
                <span></span><span></span><span></span>
            </button>
            <div class="nav-links" id="navLinks">
                <a href="index.html" data-lang="nav.home">–ì–ª–∞–≤–Ω–∞—è</a>
            </div>
            <div class="nav-controls">
                <div id="userMenu" class="user-menu"></div>
                <div class="language-switcher">
                    <button class="lang-btn" data-lang="ru" onclick="setLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
                    <button class="lang-btn" data-lang="en" onclick="setLanguage('en')">üá¨üáß English</button>
                </div>
                <div class="theme-switcher">
                    <button class="theme-btn" data-theme="default" onclick="setTheme('default')" title="–°–≤–µ—Ç–ª–∞—è">‚òÄÔ∏è</button>
                    <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')" title="–¢—ë–º–Ω–∞—è">üåô</button>
                    <button class="theme-btn" data-theme="blue" onclick="setTheme('blue')" title="–°–∏–Ω—è—è">üîµ</button>
                    <button class="theme-btn" data-theme="purple" onclick="setTheme('purple')" title="–§–∏–æ–ª–µ—Ç–æ–≤–∞—è">üü£</button>
                    <button class="theme-btn" data-theme="cyberpunk" onclick="setTheme('cyberpunk')" title="–ö–∏–±–µ—Ä–ø–∞–Ω–∫">ü§ñ</button>
                    <button class="theme-btn" data-theme="sunset" onclick="setTheme('sunset')" title="–ó–∞–∫–∞—Ç">üåÖ</button>
                    <button class="theme-btn" data-theme="forest" onclick="setTheme('forest')" title="–õ–µ—Å–Ω–∞—è">üå≤</button>
                    <button class="theme-btn" data-theme="ocean" onclick="setTheme('ocean')" title="–û–∫–µ–∞–Ω">üåä</button>
                    <button class="theme-btn" data-theme="candy" onclick="setTheme('candy')" title="–ö–∞—Ä–∞–º–µ–ª—å">üç¨</button>
                    <button class="theme-btn" data-theme="coffee" onclick="setTheme('coffee')" title="–ö–æ—Ñ–µ">‚òï</button>
                    <button class="theme-btn" data-theme="mint" onclick="setTheme('mint')" title="–ú—è—Ç–∞">üåø</button>
                    <button class="theme-btn" data-theme="lavender" onclick="setTheme('lavender')" title="–õ–∞–≤–∞–Ω–¥–∞">üíú</button>
                </div>
            </div>
        </nav>
    </header>

    <div class="video-container">
        <div class="video-wrapper">
            <video id="player">
                <source id="videoSource" src="" type="video/mp4">
            </video>
            <div class="video-controls-overlay" id="videoControlsOverlay">
                <div class="control-bar">
                    <div class="control-group">
                        <button id="playPauseBtn" class="ctrl-btn" data-lang="player.play">‚èØÔ∏è</button>
                        <button id="lockBtn" class="ctrl-btn" data-lang="player.unlock">üîì</button>
                    </div>
                    <div class="control-group">
                        <span id="currentTime">0:00</span><span id="duration"> / 0:00</span>
                    </div>
                    <div class="control-group">
                        <button id="speedBtn" class="ctrl-btn" data-lang="player.speed">‚è©</button>
                        <div id="speedMenu" class="dropdown-menu">
                            <button data-speed="0.5">0.5x</button>
                            <button data-speed="1" class="active">1x</button>
                            <button data-speed="1.5">1.5x</button>
                            <button data-speed="2">2x</button>
                        </div>
                        <button id="fullscreenBtn" class="ctrl-btn" data-lang="player.fullscreen">‚õ∂</button>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <input type="range" id="seekBar" value="0" min="0" max="100" step="0.1">
                </div>
            </div>
        </div>
        <div class="video-info">
            <h2 id="animeTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <p id="animeDescription"></p>
        </div>
        <div class="episodes-list">
            <h3 data-lang="player.episodes">üìã –°–ø–∏—Å–æ–∫ —Å–µ—Ä–∏–π</h3>
            <div id="episodes"></div>
        </div>
    </div>

    <footer>
        <p data-lang="footer.copyright">¬© 2026 AnimeWorld</p>
        <div class="quote-container">
            <button id="randomQuoteBtn" class="quote-btn" onclick="showRandomQuote()" data-lang="quote.button">üé≤ –¶–∏—Ç–∞—Ç–∞ –¥–Ω—è</button>
        </div>
    </footer>

    <script src="lang.js"></script>
    <script src="script.js"></script>
    <script>
        (function() {
            "use strict";
            let db;
            const DB_NAME = 'AnimeWorldDB', DB_VERSION = 1, STORE_NAME = 'videos';
            function initDB() {
                return new Promise((res, rej) => {
                    if (db) return res(db);
                    const r = indexedDB.open(DB_NAME, DB_VERSION);
                    r.onupgradeneeded = e => {
                        const d = e.target.result;
                        if (!d.objectStoreNames.contains(STORE_NAME)) d.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    };
                    r.onsuccess = e => { db = e.target.result; res(db); };
                    r.onerror = e => rej(e.target.error);
                });
            }
            async function loadVideoFromDB(id) {
                await initDB();
                return new Promise((res, rej) => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const req = store.get(id);
                    req.onsuccess = () => req.result ? res(URL.createObjectURL(req.result.file)) : rej('–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    req.onerror = () => rej(req.error);
                });
            }

            const params = new URLSearchParams(window.location.search);
            const animeId = parseInt(params.get('id'));
            const episodeNum = parseInt(params.get('episode')) || 1;
            const animeData = JSON.parse(localStorage.getItem('animeData') || '[]');
            const anime = animeData.find(a => a.id === animeId);
            if (!anime) { document.getElementById('animeTitle').textContent = '–ê–Ω–∏–º–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'; throw new Error('Anime not found'); }

            document.getElementById('animeTitle').textContent = `${anime.title} - ${window.getTranslation?.('player.episode') || '–°–µ—Ä–∏—è'} ${episodeNum}`;
            document.getElementById('animeDescription').textContent = anime.description || '';

            const video = anime.videos?.find(v => v.episode === episodeNum);
            const player = document.getElementById('player'), source = document.getElementById('videoSource'),
                  seek = document.getElementById('seekBar'), playBtn = document.getElementById('playPauseBtn'),
                  lockBtn = document.getElementById('lockBtn'), fullscreenBtn = document.getElementById('fullscreenBtn'),
                  curTime = document.getElementById('currentTime'), durSpan = document.getElementById('duration'),
                  speedMenu = document.getElementById('speedMenu'), controls = document.getElementById('videoControlsOverlay');

            source.removeAttribute('src');
            player.load();

            if (video) {
                if (video.type === 'url') {
                    source.src = video.url;
                    player.load();
                    window.addToHistory?.(animeId, episodeNum);
                } else if (video.type === 'indexeddb' && video.id) {
                    loadVideoFromDB(video.id)
                        .then(url => {
                            source.src = url;
                            player.load();
                            window.addToHistory?.(animeId, episodeNum);
                        })
                        .catch(console.error);
                }
            }

            let episodesHtml = '';
            for (let i = 1; i <= (anime.episodes || 12); i++) {
                const has = anime.videos?.some(v => v.episode === i);
                episodesHtml += `<span class="episode-item ${i === episodeNum ? 'active' : ''}" onclick="window.location.href='video-player.html?id=${animeId}&episode=${i}'">
                    ${window.getTranslation?.('player.episode') || '–°–µ—Ä–∏—è'} ${i}${has ? ' ‚úÖ' : ''}
                </span>`;
            }
            document.getElementById('episodes').innerHTML = episodesHtml;

            // --- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª—ã ---
            function formatTime(s) {
                if (isNaN(s)) return '0:00';
                const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sc = Math.floor(s % 60);
                return h > 0 ? `${h}:${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}` : `${m}:${sc.toString().padStart(2,'0')}`;
            }
            player.addEventListener('loadedmetadata', () => { seek.max = player.duration; durSpan.textContent = ' / ' + formatTime(player.duration); });
            player.addEventListener('timeupdate', () => { seek.value = player.currentTime; curTime.textContent = formatTime(player.currentTime); });
            seek.addEventListener('input', () => { player.currentTime = parseFloat(seek.value); });
            playBtn.addEventListener('click', () => player.paused ? player.play() : player.pause());
            player.addEventListener('play', () => playBtn.innerHTML = '‚è∏Ô∏è');
            player.addEventListener('pause', () => playBtn.innerHTML = '‚èØÔ∏è');
            let locked = false;
            lockBtn.addEventListener('click', () => {
                locked = !locked;
                lockBtn.innerHTML = locked ? 'üîí' : 'üîì';
                [playBtn, seek, document.getElementById('speedBtn'), fullscreenBtn].forEach(el => el.disabled = locked);
            });
            speedMenu.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    player.playbackRate = parseFloat(btn.dataset.speed);
                    speedMenu.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            fullscreenBtn.addEventListener('click', () => {
                const wrapper = document.querySelector('.video-wrapper');
                wrapper.requestFullscreen?.() || wrapper.webkitRequestFullscreen?.() || wrapper.msRequestFullscreen?.();
            });
            let hideTimer;
            const wrapper = document.querySelector('.video-wrapper');
            function showControls() { controls.classList.add('visible'); clearTimeout(hideTimer); hideTimer = setTimeout(() => { if (!locked) controls.classList.remove('visible'); }, 3000); }
            wrapper.addEventListener('mousemove', showControls);
            wrapper.addEventListener('touchstart', showControls);
            wrapper.addEventListener('mouseleave', () => { if (!locked) controls.classList.remove('visible'); });
            let lastTap = 0;
            wrapper.addEventListener('click', (e) => {
                const rect = wrapper.getBoundingClientRect(), x = e.clientX - rect.left, now = Date.now();
                if (now - lastTap < 300) {
                    if (x < rect.width / 2) player.currentTime -= 10; else player.currentTime += 10;
                }
                lastTap = now;
            });

            const burger = document.getElementById('burgerBtn'), nav = document.getElementById('navLinks');
            if (burger && nav) {
                burger.addEventListener('click', function () { this.classList.toggle('active'); nav.classList.toggle('active'); document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : ''; });
                nav.querySelectorAll('a').forEach(link => link.addEventListener('click', () => { burger.classList.remove('active'); nav.classList.remove('active'); document.body.style.overflow = ''; }));
            }

            if (typeof updateAllTexts === 'function') updateAllTexts();
        })();
    </script>
</body>
</html>