<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - AnimeWorld</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-wrapper">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <a href="index.html"><h2>üç• AnimeWorld</h2></a>
                <button class="admin-burger" id="adminBurgerBtn">
                    <span></span><span></span><span></span>
                </button>
                <p>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
            </div>
            <nav class="admin-nav">
                <a href="#dashboard" class="active">üìä –î–∞—à–±–æ—Ä–¥</a>
                <a href="#anime">üé¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–Ω–∏–º–µ</a>
                <a href="#videos">üìπ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</a>
                <a href="#genres">üè∑Ô∏è –ñ–∞–Ω—Ä—ã</a>
                <a href="#users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            </nav>
            <div class="admin-theme-switcher">
                <p>üé® –¢–µ–º–∞</p>
                <div class="theme-switcher">
                    <button class="theme-btn" data-theme="default" onclick="setTheme('default')">‚òÄÔ∏è</button>
                    <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">üåô</button>
                    <button class="theme-btn" data-theme="blue" onclick="setTheme('blue')">üîµ</button>
                    <button class="theme-btn" data-theme="purple" onclick="setTheme('purple')">üü£</button>
                    <button class="theme-btn" data-theme="cyberpunk" onclick="setTheme('cyberpunk')">ü§ñ</button>
                    <button class="theme-btn" data-theme="sunset" onclick="setTheme('sunset')">üåÖ</button>
                    <button class="theme-btn" data-theme="forest" onclick="setTheme('forest')">üå≤</button>
                </div>
            </div>
            <button id="logoutBtn" class="admin-logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </aside>
        <main class="admin-main">
            <!-- –î–ê–®–ë–û–†–î -->
            <section id="dashboard" class="admin-section active">
                <h1>üìä –î–∞—à–±–æ—Ä–¥</h1>
                <div class="stats-grid">
                    <div class="stat-card"><h3 id="totalAnime">0</h3><p>–í—Å–µ–≥–æ –∞–Ω–∏–º–µ</p></div>
                    <div class="stat-card"><h3 id="totalUsers">0</h3><p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p></div>
                    <div class="stat-card"><h3 id="totalEpisodes">0</h3><p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–µ—Ä–∏–π</p></div>
                </div>
            </section>
            <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–ù–ò–ú–ï -->
            <section id="anime" class="admin-section">
                <h1>üé¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–Ω–∏–º–µ</h1>
                <div class="admin-form">
                    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∞–Ω–∏–º–µ</h2>
                    <form id="addAnimeForm">
                        <div class="form-row">
                            <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="title" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required></div>
                            <div><label>–ñ–∞–Ω—Ä</label><select id="genre" required></select></div>
                        </div>
                        <div class="form-row">
                            <div><label>–ì–æ–¥</label><input type="number" id="year" placeholder="2024" required></div>
                            <div><label>–ö–æ–ª-–≤–æ —Å–µ—Ä–∏–π</label><input type="number" id="episodes" placeholder="12" required></div>
                        </div>
                        <div><label>–†–µ–π—Ç–∏–Ω–≥ (0-10)</label><input type="number" id="rating" step="0.1" min="0" max="10" placeholder="8.5"></div>
                        <div><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="description" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea></div>
                        <div><label>üñºÔ∏è –ü–æ—Å—Ç–µ—Ä</label><input type="file" id="animeImage" accept="image/*"></div>
                        <button type="submit" class="admin-submit-btn">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </form>
                </div>
                <div class="admin-list">
                    <h2>üìã –°–ø–∏—Å–æ–∫ –∞–Ω–∏–º–µ</h2>
                    <div id="animeList"></div>
                </div>
            </section>
            <!-- –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û -->
            <section id="videos" class="admin-section">
                <h1>üìπ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</h1>
                <div class="admin-form">
                    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–∏—é</h2>
                    <form id="addVideoForm">
                        <div><label>–ê–Ω–∏–º–µ</label><select id="animeSelect" required></select></div>
                        <div><label>–ù–æ–º–µ—Ä —Å–µ—Ä–∏–∏</label><input type="number" id="episode" placeholder="1" min="1" required></div>
                        <div><label>–°–ø–æ—Å–æ–± –∑–∞–≥—Ä—É–∑–∫–∏</label>
                            <div style="display:flex; gap:1.5rem;">
                                <label><input type="radio" name="videoType" value="file" checked> üìÅ –§–∞–π–ª</label>
                                <label><input type="radio" name="videoType" value="url"> üîó –°—Å—ã–ª–∫–∞</label>
                            </div>
                        </div>
                        <div id="fileUploadBlock">
                            <input type="file" id="videoFile" accept="video/mp4,video/webm">
                            <div class="form-hint">‚úÖ MP4, WebM –¥–æ 1 –ì–ë (IndexedDB)</div>
                            <div id="uploadProgress" class="upload-progress"><div class="progress-bar" style="width:0%;"></div></div>
                        </div>
                        <div id="urlUploadBlock" style="display:none;">
                            <input type="url" id="videoUrl" placeholder="https://example.com/video.mp4">
                            <div class="form-hint">‚úÖ –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ .mp4</div>
                        </div>
                        <button type="submit" class="admin-submit-btn">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </form>
                </div>
                <div class="admin-list">
                    <h2>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
                    <div id="recentVideos"></div>
                </div>
            </section>
            <!-- –ñ–ê–ù–†–´ -->
            <section id="genres" class="admin-section">
                <h1>üè∑Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∞–Ω—Ä–∞–º–∏</h1>
                <div class="admin-form">
                    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∂–∞–Ω—Ä</h2>
                    <div style="display:flex; gap:1rem;">
                        <input type="text" id="newGenre" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: horror" style="flex:1;">
                        <button id="addGenreBtn" class="admin-submit-btn" style="margin-top:0;">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div class="admin-list">
                    <h2>üìã –°–ø–∏—Å–æ–∫ –∂–∞–Ω—Ä–æ–≤</h2>
                    <div id="genresList" class="genre-list"></div>
                </div>
            </section>
            <!-- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò -->
            <section id="users" class="admin-section">
                <h1>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
                <div class="admin-list">
                    <div><input type="text" id="userSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∏–Ω—É –∏–ª–∏ email"></div>
                    <div id="usersList"></div>
                </div>
            </section>
        </main>
    </div>
    <!-- –ú–û–î–ê–õ–ö–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ï–†–ò–Ø–ú–ò -->
    <div id="episodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalAnimeTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–∏—è–º–∏</h2>
                <span class="modal-close" onclick="closeEpisodeModal()">&times;</span>
            </div>
            <div id="episodeList"></div>
        </div>
    </div>
    <!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ê–ù–ò–ú–ï -->
    <div id="editAnimeModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∏–º–µ</h2>
                <span class="modal-close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editAnimeForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="editTitle" required></div>
                    <div><label>–ñ–∞–Ω—Ä</label><select id="editGenre" required></select></div>
                </div>
                <div class="form-row">
                    <div><label>–ì–æ–¥</label><input type="number" id="editYear" required></div>
                    <div><label>–ö–æ–ª-–≤–æ —Å–µ—Ä–∏–π</label><input type="number" id="editEpisodes" required></div>
                </div>
                <div><label>–†–µ–π—Ç–∏–Ω–≥</label><input type="number" id="editRating" step="0.1" min="0" max="10"></div>
                <div><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="editDescription" rows="4"></textarea></div>
                <div><label>üñºÔ∏è –ü–æ—Å—Ç–µ—Ä</label><input type="file" id="editImage" accept="image/*"></div>
                <div style="display:flex; gap:1rem; justify-content:flex-end;">
                    <button type="button" onclick="closeEditModal()" class="modal-btn cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="modal-btn confirm">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    <script src="script.js"></script>
    <script>
        (function() {
            "use strict";
            // ---------- –ü–†–û–í–ï–†–ö–ê –ê–î–ú–ò–ù–ê ----------
            const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!user || user.role !== 'admin') {
                window.showAlertModal?.('‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω!', () => window.location.href='index.html') 
                    || (alert('‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω!'), window.location.href='index.html');
                return;
            }

            // ---------- INDEXEDDB ----------
            let db;
            const DB_NAME = 'AnimeWorldDB';
            const DB_VERSION = 1;
            const STORE_NAME = 'videos';
            function initIndexedDB() {
                return new Promise((resolve, reject) => {
                    if (db) return resolve(db);
                    const r = indexedDB.open(DB_NAME, DB_VERSION);
                    r.onupgradeneeded = e => {
                        const d = e.target.result;
                        if (!d.objectStoreNames.contains(STORE_NAME)) {
                            const s = d.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            s.createIndex('animeId', 'animeId', { unique: false });
                            s.createIndex('episode', 'episode', { unique: false });
                        }
                    };
                    r.onsuccess = e => { db = e.target.result; resolve(db); };
                    r.onerror = e => reject(e.target.error);
                });
            }

            // ---------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ----------
            const safeEscapeHtml = (t) => window.escapeHtml?.(t) || t || '';
            const safeGenerateSvg = (t, w=50, h=70) => window.generateSvgThumbnail?.(t, w, h) || 'data:...';
            const safeShowNotif = (m, t) => window.showNotification?.(m, t) || console.log(m);
            const safeShowAlert = (m, c) => window.showAlertModal?.(m, c) || (alert(m), c?.());
            const safeShowConfirm = (m, y, n) => window.showConfirmModal?.(m, y, n) || (confirm(m)?y?.():n?.());

            // ---------- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• (—á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ script.js) ----------
            function loadStats() {
                const a = JSON.parse(localStorage.getItem('animeData') || '[]');
                const u = JSON.parse(localStorage.getItem('users') || '[]');
                let e = 0; a.forEach(a => e += a.videos?.length || 0);
                document.getElementById('totalAnime').textContent = a.length;
                document.getElementById('totalUsers').textContent = u.length;
                document.getElementById('totalEpisodes').textContent = e;
            }

            function loadAnimeList() {
                const c = document.getElementById('animeList'); if (!c) return;
                const a = JSON.parse(localStorage.getItem('animeData') || '[]');
                if (!a.length) { c.innerHTML = '<p style="color:#666;">–ê–Ω–∏–º–µ –ø–æ–∫–∞ –Ω–µ—Ç</p>'; return; }
                c.innerHTML = a.map(a => {
                    const t = a.image || safeGenerateSvg(a.title);
                    return `<div class="admin-list-item">
                        <div class="item-info">
                            <img src="${t}" alt="${safeEscapeHtml(a.title)}" onerror="this.src='${safeGenerateSvg(a.title)}'">
                            <div><strong>${safeEscapeHtml(a.title)}</strong><span style="display:block; color:#666; font-size:0.9rem;">${a.episodes||0} —Å–µ—Ä–∏–π ‚Ä¢ ${a.year||'?'}</span></div>
                        </div>
                        <div class="item-actions">
                            <button onclick="openEditModal(${a.id})" class="btn-small" style="background:#0984e3; color:white;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button onclick="openEpisodeModal(${a.id}, '${safeEscapeHtml(a.title).replace(/'/g, "\\'")}')" class="btn-small" style="background:#00b894; color:white;">üìπ –°–µ—Ä–∏–∏</button>
                            <button onclick="deleteAnime(${a.id})" class="btn-small btn-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>`}).join('');
            }

            // –£–î–ê–õ–ï–ù–ò–ï –ê–ù–ò–ú–ï (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º)
            window.deleteAnime = function(id) {
                safeShowConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∞–Ω–∏–º–µ? –í—Å–µ —Å–µ—Ä–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.', async () => {
                    await initIndexedDB();
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const index = store.index('animeId');
                    index.getAllKeys(IDBKeyRange.only(id)).onsuccess = e => e.target.result.forEach(k => store.delete(k));
                    let a = JSON.parse(localStorage.getItem('animeData') || '[]');
                    a = a.filter(a => a.id !== id);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                    if (window.syncAnimeData) window.syncAnimeData(a);
                    else localStorage.setItem('animeData', JSON.stringify(a));
                    safeShowNotif('üóëÔ∏è –ê–Ω–∏–º–µ —É–¥–∞–ª–µ–Ω–æ');
                    loadStats(); loadAnimeList(); loadAnimeSelect(); loadRecentVideos();
                });
            };

            function loadAnimeSelect() {
                const s = document.getElementById('animeSelect'); if (!s) return;
                const a = JSON.parse(localStorage.getItem('animeData') || '[]');
                s.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∞–Ω–∏–º–µ ‚Äî</option>' + 
                    a.map(a => `<option value="${a.id}">${safeEscapeHtml(a.title)}</option>`).join('');
            }

            // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ï–†–ò–Ø–ú–ò ==========
            window.openEpisodeModal = function(animeId, animeTitle) {
                document.getElementById('modalAnimeTitle').textContent = `–°–µ—Ä–∏–∏: ${animeTitle}`;
                const c = document.getElementById('episodeList');
                const a = JSON.parse(localStorage.getItem('animeData') || '[]').find(a => a.id === animeId);
                if (!a?.videos?.length) c.innerHTML = '<p style="color:#666;">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π</p>';
                else c.innerHTML = a.videos.sort((x,y)=>x.episode-y.episode).map(v =>
                    `<div class="episode-item-admin">
                        <span><strong>–°–µ—Ä–∏—è ${v.episode}</strong> (${v.type==='indexeddb'?'üìÅ –§–∞–π–ª':'üîó –°—Å—ã–ª–∫–∞'})</span>
                        <button onclick="deleteEpisode(${animeId}, ${v.episode})" class="btn-episode-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>`).join('');
                document.getElementById('episodeModal').classList.add('active');
            };
            window.closeEpisodeModal = () => document.getElementById('episodeModal').classList.remove('active');
            window.deleteEpisode = async function(animeId, episode) {
                safeShowConfirm(`–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–∏—é ${episode}?`, async () => {
                    let a = JSON.parse(localStorage.getItem('animeData') || '[]');
                    const an = a.find(a => a.id === animeId);
                    if (an?.videos) {
                        const v = an.videos.find(v => v.episode === episode);
                        if (v?.type === 'indexeddb' && v?.id) {
                            await initIndexedDB();
                            db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(v.id);
                        }
                        an.videos = an.videos.filter(v => v.episode !== episode);
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                        if (window.syncAnimeData) window.syncAnimeData(a);
                        else localStorage.setItem('animeData', JSON.stringify(a));
                        safeShowNotif(`üóëÔ∏è –°–µ—Ä–∏—è ${episode} —É–¥–∞–ª–µ–Ω–∞`);
                        loadStats(); loadRecentVideos();
                        if (document.getElementById('episodeModal').classList.contains('active'))
                            window.openEpisodeModal(animeId, an.title);
                    }
                });
            };

            // ========== –ü–û–°–õ–ï–î–ù–ò–ï –ó–ê–ì–†–£–ó–ö–ò ==========
            async function loadRecentVideos() {
                const c = document.getElementById('recentVideos'); if (!c) return;
                const a = JSON.parse(localStorage.getItem('animeData') || '[]');
                const vids = [];
                a.forEach(a => a.videos?.forEach(v => vids.push({ animeId: a.id, animeTitle: a.title, episode: v.episode, type: v.type })));
                const recent = vids.slice(-10).reverse();
                c.innerHTML = recent.length ? recent.map(v =>
                    `<div style="display:flex; justify-content:space-between; align-items:center; padding:0.8rem; border-bottom:1px solid #eee;">
                        <span><strong>${safeEscapeHtml(v.animeTitle)}</strong> ‚Äî –°–µ—Ä–∏—è ${v.episode} (${v.type==='indexeddb'?'üìÅ':'üîó'})</span>
                        <button onclick="deleteEpisode(${v.animeId}, ${v.episode})" class="btn-small" style="background:#ff7675; color:white;">üóëÔ∏è</button>
                    </div>`).join('') : '<p style="color:#666;">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π</p>';
            }

            // ---------- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –§–ê–ô–õ/–°–°–´–õ–ö–ê ----------
            const fileRadio = document.querySelector('input[value="file"]');
            const urlRadio = document.querySelector('input[value="url"]');
            const fileBlock = document.getElementById('fileUploadBlock');
            const urlBlock = document.getElementById('urlUploadBlock');
            if (fileRadio && urlRadio) {
                fileRadio.addEventListener('change', ()=>{ fileBlock.style.display='block'; urlBlock.style.display='none'; });
                urlRadio.addEventListener('change', ()=>{ fileBlock.style.display='none'; urlBlock.style.display='block'; });
            }

            // ---------- –°–û–•–†–ê–ù–ï–ù–ò–ï –§–ê–ô–õ–ê –í INDEXEDDB ----------
            async function saveFileToIndexedDB(file, animeId, episode) {
                await initIndexedDB();
                const id = `${animeId}_${episode}_${Date.now()}`;
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                return new Promise((res, rej) => {
                    const r = store.put({ id, animeId, episode, file, name: file.name, type: file.type, size: file.size });
                    r.onsuccess = () => res(id);
                    r.onerror = () => rej(r.error);
                });
            }

            // ---------- –î–û–ë–ê–í–õ–ï–ù–ò–ï –í–ò–î–ï–û ----------
            document.getElementById('addVideoForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const animeId = parseInt(document.getElementById('animeSelect').value);
                if (!animeId) { safeShowAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–Ω–∏–º–µ!'); return; }
                const episode = parseInt(document.getElementById('episode').value);
                if (!episode || episode < 1) { safeShowAlert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å–µ—Ä–∏–∏!'); return; }
                const useFile = document.querySelector('input[name="videoType"]:checked')?.value === 'file';
                if (useFile) {
                    const file = document.getElementById('videoFile').files[0];
                    if (!file) { safeShowAlert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª!'); return; }
                    if (!file.type.includes('mp4') && !file.type.includes('webm')) { safeShowAlert('–¢–æ–ª—å–∫–æ MP4/WebM!'); return; }
                    if (file.size > 1024*1024*1024) { safeShowAlert('–§–∞–π–ª >1 –ì–ë!'); return; }
                    const pb = document.querySelector('.progress-bar');
                    const pc = document.getElementById('uploadProgress');
                    pc.style.display = 'block'; pb.style.width = '0%';
                    let p = 0, i = setInterval(() => { p += 5; if (p <= 90) pb.style.width = p + '%'; }, 100);
                    try {
                        const videoId = await saveFileToIndexedDB(file, animeId, episode);
                        clearInterval(i); pb.style.width = '100%'; setTimeout(() => pc.style.display = 'none', 500);
                        let a = JSON.parse(localStorage.getItem('animeData') || '[]');
                        const an = a.find(a => a.id === animeId);
                        if (an) {
                            if (!an.videos) an.videos = [];
                            an.videos = an.videos.filter(v => v.episode !== episode);
                            an.videos.push({ episode, type: 'indexeddb', id: videoId, size: file.size });
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                            if (window.syncAnimeData) window.syncAnimeData(a);
                            else localStorage.setItem('animeData', JSON.stringify(a));
                            safeShowNotif(`‚úÖ –°–µ—Ä–∏—è ${episode} –∑–∞–≥—Ä—É–∂–µ–Ω–∞!`);
                            e.target.reset();
                            fileRadio.checked = true;
                            fileBlock.style.display = 'block';
                            urlBlock.style.display = 'none';
                            loadStats(); loadRecentVideos();
                        }
                    } catch (err) {
                        clearInterval(i); pc.style.display = 'none';
                        safeShowAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ IndexedDB: ' + err.message);
                    }
                } else {
                    const url = document.getElementById('videoUrl').value.trim();
                    if (!url) { safeShowAlert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É!'); return; }
                    let a = JSON.parse(localStorage.getItem('animeData') || '[]');
                    const an = a.find(a => a.id === animeId);
                    if (an) {
                        if (!an.videos) an.videos = [];
                        an.videos = an.videos.filter(v => v.episode !== episode);
                        an.videos.push({ episode, type: 'url', url });
                        if (window.syncAnimeData) window.syncAnimeData(a);
                        else localStorage.setItem('animeData', JSON.stringify(a));
                        safeShowNotif(`‚úÖ –°–µ—Ä–∏—è ${episode} –¥–æ–±–∞–≤–ª–µ–Ω–∞ (—Å—Å—ã–ª–∫–∞)!`);
                        e.target.reset();
                        fileRadio.checked = true;
                        fileBlock.style.display = 'block';
                        urlBlock.style.display = 'none';
                        loadStats(); loadRecentVideos();
                    }
                }
            });

            // ========== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ê–ù–ò–ú–ï ==========
            window.openEditModal = function(id) {
                const a = JSON.parse(localStorage.getItem('animeData') || '[]').find(a => a.id === id);
                if (!a) return;
                document.getElementById('editId').value = a.id;
                document.getElementById('editTitle').value = a.title || '';
                document.getElementById('editYear').value = a.year || '';
                document.getElementById('editEpisodes').value = a.episodes || 12;
                document.getElementById('editRating').value = a.rating || '';
                document.getElementById('editDescription').value = a.description || '';
                const eg = document.getElementById('editGenre');
                const g = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                eg.innerHTML = g.map(g => `<option value="${g}" ${g === a.genre ? 'selected' : ''}>${g}</option>`).join('');
                document.getElementById('editAnimeModal').classList.add('active');
            };
            window.closeEditModal = function() {
                document.getElementById('editAnimeModal').classList.remove('active');
                document.getElementById('editImage').value = '';
            };
            document.getElementById('editAnimeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const id = parseInt(document.getElementById('editId').value);
                let a = JSON.parse(localStorage.getItem('animeData') || '[]');
                const i = a.findIndex(a => a.id === id);
                if (i === -1) return;
                const imgFile = document.getElementById('editImage').files[0];
                const proc = imgFile ? new Promise(r => { const fr = new FileReader(); fr.onload = e => r(e.target.result); fr.readAsDataURL(imgFile); }) : Promise.resolve(a[i].image);
                const imgData = await proc;
                a[i] = { ...a[i],
                    title: document.getElementById('editTitle').value.trim(),
                    genre: document.getElementById('editGenre').value,
                    year: parseInt(document.getElementById('editYear').value),
                    episodes: parseInt(document.getElementById('editEpisodes').value),
                    rating: parseFloat(document.getElementById('editRating').value) || 0,
                    description: document.getElementById('editDescription').value.trim(),
                    image: imgData
                };
                if (window.syncAnimeData) window.syncAnimeData(a);
                else localStorage.setItem('animeData', JSON.stringify(a));
                safeShowNotif('‚úÖ –ê–Ω–∏–º–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                closeEditModal();
                loadStats(); loadAnimeList(); loadAnimeSelect();
            });

            // ========== –ñ–ê–ù–†–´ ==========
            function updateGenreSelects() {
                const g = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                const ag = document.getElementById('genre'); if (ag) ag.innerHTML = g.map(g => `<option value="${g}">${g}</option>`).join('');
                const eg = document.getElementById('editGenre'); if (eg) {
                    const cv = eg.value;
                    eg.innerHTML = g.map(g => `<option value="${g}" ${g === cv ? 'selected' : ''}>${g}</option>`).join('');
                }
            }
            function loadGenresList() {
                const c = document.getElementById('genresList'); if (!c) return;
                const g = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                const a = JSON.parse(localStorage.getItem('animeData') || '[]');
                c.innerHTML = g.map(ge => {
                    const cnt = a.filter(a => a.genre === ge).length;
                    return `<div class="genre-item">
                        <div class="genre-info">
                            <span class="genre-name">${safeEscapeHtml(ge)}</span>
                            <span class="genre-count">${cnt} –∞–Ω–∏–º–µ</span>
                        </div>
                        <button onclick="deleteGenreHandler('${safeEscapeHtml(ge).replace(/'/g, "\\'")}', ${cnt})" 
                            class="btn-small ${cnt > 0 ? 'btn-disabled' : 'btn-delete'}" ${cnt > 0 ? 'disabled' : ''}>
                            ${cnt > 0 ? 'üîí –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è' : 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å'}
                        </button>
                    </div>`}).join('');
            }
            window.deleteGenreHandler = function(genre, count) {
                if (count > 0) { safeShowAlert(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∂–∞–Ω—Ä ¬´${genre}¬ª, –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ${count} –∞–Ω–∏–º–µ.`); return; }
                safeShowConfirm(`–£–¥–∞–ª–∏—Ç—å –∂–∞–Ω—Ä ¬´${genre}¬ª?`, () => {
                    let g = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                    g = g.filter(g => g !== genre);
                    localStorage.setItem('animeGenres', JSON.stringify(g));
                    safeShowNotif(`üóëÔ∏è –ñ–∞–Ω—Ä ¬´${genre}¬ª —É–¥–∞–ª—ë–Ω`);
                    loadGenresList(); updateGenreSelects();
                    window.dispatchEvent(new Event('storage'));
                });
            };
            document.getElementById('addGenreBtn')?.addEventListener('click', () => {
                const inp = document.getElementById('newGenre');
                const ng = inp.value.trim().toLowerCase();
                if (!ng) { safeShowAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∂–∞–Ω—Ä–∞!'); return; }
                let g = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                if (g.includes(ng)) { safeShowAlert('–¢–∞–∫–æ–π –∂–∞–Ω—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!'); return; }
                g.push(ng); g.sort();
                localStorage.setItem('animeGenres', JSON.stringify(g));
                safeShowNotif(`‚úÖ –ñ–∞–Ω—Ä ¬´${ng}¬ª –¥–æ–±–∞–≤–ª–µ–Ω`);
                inp.value = '';
                loadGenresList(); updateGenreSelects();
                window.dispatchEvent(new Event('storage'));
            });

            // ========== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ==========
            function loadUsersList() {
                const c = document.getElementById('usersList'); if (!c) return;
                const u = JSON.parse(localStorage.getItem('users') || '[]');
                if (!u.length) { c.innerHTML = '<p style="color:#666;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</p>'; return; }
                c.innerHTML = u.map(u => {
                    const av = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'%3E%3Ccircle cx='25' cy='25' r='25' fill='%236c5ce7'/%3E%3Ctext x='50%25' y='50%25' font-size='25' fill='white' text-anchor='middle' dy='.3em'%3E${encodeURIComponent(u.username.charAt(0).toUpperCase())}%3C/text%3E%3C/svg%3E`;
                    return `<div class="user-card">
                        <div class="user-card-avatar"><img src="${av}" alt="avatar"></div>
                        <div style="flex:1;">
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <strong>${safeEscapeHtml(u.username)}</strong>
                                <span class="user-badge ${u.role === 'admin' ? 'admin' : ''}">${u.role === 'admin' ? '–ê–¥–º–∏–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
                            </div>
                            <div style="color:#666;">${safeEscapeHtml(u.email)}</div>
                        </div>
                        ${u.role !== 'admin' ? `<button onclick="makeAdmin(${u.id})" class="btn-small" style="background:#00b894; color:white;">üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>` : ''}
                    </div>`}).join('');
            }
            window.makeAdmin = function(id) {
                safeShowConfirm('–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?', () => {
                    let u = JSON.parse(localStorage.getItem('users') || '[]');
                    const us = u.find(u => u.id === id);
                    if (us) { us.role = 'admin'; localStorage.setItem('users', JSON.stringify(u)); safeShowNotif('üëë –ê–¥–º–∏–Ω –Ω–∞–∑–Ω–∞—á–µ–Ω'); loadUsersList(); }
                });
            };

            // ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ê–ù–ò–ú–ï ==========
            document.getElementById('addAnimeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const title = document.getElementById('title').value.trim();
                if (!title) { safeShowAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!'); return; }
                const imgFile = document.getElementById('animeImage').files[0];
                const proc = imgFile ? new Promise(r => { const fr = new FileReader(); fr.onload = e => r(e.target.result); fr.readAsDataURL(imgFile); }) : Promise.resolve('');
                proc.then(imgData => {
                    const n = {
                        id: Date.now(),
                        title,
                        genre: document.getElementById('genre').value,
                        year: parseInt(document.getElementById('year').value) || new Date().getFullYear(),
                        episodes: parseInt(document.getElementById('episodes').value) || 12,
                        rating: parseFloat(document.getElementById('rating').value) || 0,
                        description: document.getElementById('description').value.trim() || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                        image: imgData,
                        videos: []
                    };
                    let a = JSON.parse(localStorage.getItem('animeData') || '[]');
                    a.push(n);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                    if (window.syncAnimeData) window.syncAnimeData(a);
                    else localStorage.setItem('animeData', JSON.stringify(a));
                    safeShowNotif('‚úÖ –ê–Ω–∏–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
                    e.target.reset();
                    loadStats(); loadAnimeList(); loadAnimeSelect();
                }).catch(e => safeShowAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + e.message));
            });

            // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
            const navLinks = document.querySelectorAll('.admin-nav a');
            const sections = document.querySelectorAll('.admin-section');
            function activateSection(targetId) {
                navLinks.forEach(l => l.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));
                const al = Array.from(navLinks).find(l => l.getAttribute('href') === `#${targetId}`);
                if (al) al.classList.add('active');
                const as = document.getElementById(targetId);
                if (as) as.classList.add('active');
                if (targetId === 'videos') { loadAnimeSelect(); loadRecentVideos(); }
                if (targetId === 'users') loadUsersList();
                if (targetId === 'genres') { loadGenresList(); updateGenreSelects(); }
            }
            navLinks.forEach(l => l.addEventListener('click', e => { e.preventDefault(); activateSection(l.getAttribute('href').substring(1)); }));

            // ========== –ë–£–†–ì–ï–† –ê–î–ú–ò–ù–ö–ò ==========
            const adminBurger = document.getElementById('adminBurgerBtn');
            const adminNav = document.querySelector('.admin-nav');
            const adminTheme = document.querySelector('.admin-theme-switcher');
            if (adminBurger) adminBurger.addEventListener('click', function() { this.classList.toggle('active'); adminNav.classList.toggle('active'); adminTheme.classList.toggle('active'); });

            // ========== –í–´–•–û–î ==========
            document.getElementById('logoutBtn').addEventListener('click', () => {
                safeShowConfirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?', () => { localStorage.removeItem('currentUser'); window.location.href = 'login.html'; });
            });

            // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
            initIndexedDB().catch(console.error);
            loadStats(); loadAnimeList(); loadUsersList(); loadAnimeSelect(); loadRecentVideos();
            updateGenreSelects();
            if (document.getElementById('genres')?.classList.contains('active')) loadGenresList();
            const hash = window.location.hash.substring(1);
            if (hash && ['dashboard', 'anime', 'videos', 'genres', 'users'].includes(hash)) activateSection(hash);
        })();
    </script>
</body>
</html>