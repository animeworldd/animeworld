<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - AnimeWorld</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="admin-wrapper">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <a href="index.html">
                    <h2>üç• AnimeWorld</h2>
                </a>
                <button class="admin-burger" id="adminBurgerBtn">
                    <span></span><span></span><span></span>
                </button>
                <p>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
            </div>
            <nav class="admin-nav">
                <a href="#dashboard" class="active">üìä –î–∞—à–±–æ—Ä–¥</a>
                <a href="#anime">üé¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–Ω–∏–º–µ</a>
                <a href="#videos">üìπ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</a>
                <a href="#genres">üè∑Ô∏è –ñ–∞–Ω—Ä—ã</a>
                <a href="#users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            </nav>
            <div class="admin-theme-switcher">
                <p>üé® –¢–µ–º–∞</p>
                <div class="theme-switcher" style="justify-content: center;">
                    <button class="theme-btn" data-theme="default" onclick="window.setTheme('default')">‚òÄÔ∏è</button>
                    <button class="theme-btn" data-theme="dark" onclick="window.setTheme('dark')">üåô</button>
                    <button class="theme-btn" data-theme="blue" onclick="window.setTheme('blue')">üîµ</button>
                    <button class="theme-btn" data-theme="purple" onclick="window.setTheme('purple')">üü£</button>
                    <button class="theme-btn" data-theme="cyberpunk" onclick="window.setTheme('cyberpunk')">ü§ñ</button>
                    <button class="theme-btn" data-theme="sunset" onclick="window.setTheme('sunset')">üåÖ</button>
                    <button class="theme-btn" data-theme="forest" onclick="window.setTheme('forest')">üå≤</button>
                    <button class="theme-btn" data-theme="ocean" onclick="window.setTheme('ocean')">üåä</button>
                    <button class="theme-btn" data-theme="candy" onclick="window.setTheme('candy')">üç¨</button>
                    <button class="theme-btn" data-theme="coffee" onclick="window.setTheme('coffee')">‚òï</button>
                    <button class="theme-btn" data-theme="mint" onclick="window.setTheme('mint')">üåø</button>
                    <button class="theme-btn" data-theme="lavender" onclick="window.setTheme('lavender')">üíú</button>
                </div>
            </div>
            <div class="admin-language-switcher">
                <p>üåê –Ø–∑—ã–∫</p>
                <div class="language-switcher" style="justify-content: center;">
                    <button class="lang-btn" onclick="if(typeof setLanguage==='function') setLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
                    <button class="lang-btn" onclick="if(typeof setLanguage==='function') setLanguage('en')">üá¨üáß English</button>
                </div>
            </div>
            <button id="logoutBtn" class="admin-logout-btn">üö™ –í—ã–π—Ç–∏</button>
        </aside>

        <main class="admin-main">
            <!-- –î–ê–®–ë–û–†–î -->
            <section id="dashboard" class="admin-section active">
                <h1>üìä –î–∞—à–±–æ—Ä–¥</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalAnime">0</h3>
                        <p>–í—Å–µ–≥–æ –∞–Ω–∏–º–µ</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalUsers">0</h3>
                        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalEpisodes">0</h3>
                        <p>–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–µ—Ä–∏–π</p>
                    </div>
                </div>
            </section>

            <!-- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–ù–ò–ú–ï -->
            <section id="anime" class="admin-section">
                <h1>üé¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–Ω–∏–º–µ</h1>
                <div class="admin-form">
                    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∞–Ω–∏–º–µ</h2>
                    <form id="addAnimeForm">
                        <div class="form-row">
                            <div>
                                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                <input type="text" id="title" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
                            </div>
                            <div>
                                <label>–ñ–∞–Ω—Ä</label>
                                <select id="genre" required></select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>–ì–æ–¥</label>
                                <input type="number" id="year" placeholder="2024" required>
                            </div>
                            <div>
                                <label>–ö–æ–ª-–≤–æ —Å–µ—Ä–∏–π</label>
                                <input type="number" id="episodes" placeholder="12" required>
                            </div>
                        </div>
                        <div>
                            <label>–†–µ–π—Ç–∏–Ω–≥ (0-10)</label>
                            <input type="number" id="rating" step="0.1" min="0" max="10" placeholder="8.5">
                        </div>
                        <div>
                            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea id="description" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
                        </div>
                        <div>
                            <label>üñºÔ∏è –ü–æ—Å—Ç–µ—Ä</label>
                            <input type="file" id="animeImage" accept="image/*">
                            <div class="form-hint">JPEG/PNG. –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –∑–∞–≥–ª—É—à–∫–∞.</div>
                        </div>
                        <button type="submit" class="admin-submit-btn">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </form>
                </div>
                <div class="admin-list">
                    <h2>üìã –°–ø–∏—Å–æ–∫ –∞–Ω–∏–º–µ</h2>
                    <div id="animeList"></div>
                </div>
            </section>

            <!-- –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û -->
            <section id="videos" class="admin-section">
                <h1>üìπ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ</h1>
                <div class="admin-form">
                    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–∏—é</h2>
                    <form id="addVideoForm">
                        <div>
                            <label>–ê–Ω–∏–º–µ</label>
                            <select id="animeSelect" required></select>
                        </div>
                        <div>
                            <label>–ù–æ–º–µ—Ä —Å–µ—Ä–∏–∏</label>
                            <input type="number" id="episode" placeholder="1" min="1" required>
                        </div>
                        <div>
                            <label>–°–ø–æ—Å–æ–± –∑–∞–≥—Ä—É–∑–∫–∏</label>
                            <div style="display:flex; gap:1.5rem;">
                                <label><input type="radio" name="videoType" value="file" checked> üìÅ –§–∞–π–ª</label>
                                <label><input type="radio" name="videoType" value="url"> üîó –°—Å—ã–ª–∫–∞</label>
                            </div>
                        </div>
                        <div id="fileUploadBlock">
                            <input type="file" id="videoFile" accept="video/mp4,video/webm">
                            <div class="form-hint">‚úÖ MP4, WebM –¥–æ 1 –ì–ë (IndexedDB)</div>
                            <div id="uploadProgress" class="upload-progress"><div class="progress-bar" style="width:0%;"></div></div>
                        </div>
                        <div id="urlUploadBlock" style="display:none;">
                            <input type="url" id="videoUrl" placeholder="https://example.com/video.mp4">
                            <div class="form-hint">‚úÖ –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ .mp4</div>
                        </div>
                        <button type="submit" class="admin-submit-btn">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </form>
                </div>
                <div class="admin-list">
                    <h2>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
                    <div id="recentVideos"></div>
                </div>
            </section>

            <!-- –ñ–ê–ù–†–´ -->
            <section id="genres" class="admin-section">
                <h1>üè∑Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∞–Ω—Ä–∞–º–∏</h1>
                <div class="admin-form">
                    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∂–∞–Ω—Ä</h2>
                    <div style="display:flex; gap:1rem;">
                        <input type="text" id="newGenre" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: horror" style="flex:1;">
                        <button id="addGenreBtn" class="admin-submit-btn" style="margin-top:0;">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                <div class="admin-list">
                    <h2>üìã –°–ø–∏—Å–æ–∫ –∂–∞–Ω—Ä–æ–≤</h2>
                    <div id="genresList" class="genre-list"></div>
                </div>
            </section>

            <!-- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò -->
            <section id="users" class="admin-section">
                <h1>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
                <div class="admin-list">
                    <div>
                        <input type="text" id="userSearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∏–Ω—É –∏–ª–∏ email">
                    </div>
                    <div id="usersList"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –°–ï–†–ò–Ø–ú–ò -->
    <div id="episodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalAnimeTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–∏—è–º–∏</h2>
                <span class="modal-close" onclick="closeEpisodeModal()">&times;</span>
            </div>
            <div id="episodeList"></div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ê–ù–ò–ú–ï -->
    <div id="editAnimeModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∏–º–µ</h2>
                <span class="modal-close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editAnimeForm">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div>
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="editTitle" required>
                    </div>
                    <div>
                        <label>–ñ–∞–Ω—Ä</label>
                        <select id="editGenre" required></select>
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>–ì–æ–¥</label>
                        <input type="number" id="editYear" required>
                    </div>
                    <div>
                        <label>–ö–æ–ª-–≤–æ —Å–µ—Ä–∏–π</label>
                        <input type="number" id="editEpisodes" required>
                    </div>
                </div>
                <div>
                    <label>–†–µ–π—Ç–∏–Ω–≥</label>
                    <input type="number" id="editRating" step="0.1" min="0" max="10">
                </div>
                <div>
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="editDescription" rows="4"></textarea>
                </div>
                <div>
                    <label>üñºÔ∏è –ü–æ—Å—Ç–µ—Ä</label>
                    <input type="file" id="editImage" accept="image/*">
                    <div class="form-hint">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å –ø–æ—Å—Ç–µ—Ä.</div>
                </div>
                <div style="display:flex; gap:1rem; justify-content:flex-end;">
                    <button type="button" onclick="closeEditModal()" class="modal-btn cancel">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="modal-btn confirm">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        (function() {
            "use strict";

            // ---------- –ü–†–û–í–ï–†–ö–ê –ê–î–ú–ò–ù–ê ----------
            const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!user || user.role !== 'admin') {
                if (typeof window.showAlertModal === 'function') {
                    window.showAlertModal('‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω! –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.', () => window.location.href = 'index.html');
                } else {
                    alert('‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω!');
                    window.location.href = 'index.html';
                }
                return;
            }

            // ---------- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ----------
            let db;
            const DB_NAME = 'AnimeWorldDB';
            const DB_VERSION = 1;
            const STORE_NAME = 'videos';

            // ---------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø INDEXEDDB ----------
            function initIndexedDB() {
                return new Promise((resolve, reject) => {
                    if (db) return resolve(db);
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const database = e.target.result;
                        if (!database.objectStoreNames.contains(STORE_NAME)) {
                            const store = database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            store.createIndex('animeId', 'animeId', { unique: false });
                            store.createIndex('episode', 'episode', { unique: false });
                        }
                    };
                    request.onsuccess = (e) => {
                        db = e.target.result;
                        resolve(db);
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            // ---------- –ë–ï–ó–û–ü–ê–°–ù–´–ï –û–ë–Å–†–¢–ö–ò ----------
            const safeEscapeHtml = (text) => window.escapeHtml ? window.escapeHtml(text) : (text || '');
            const safeGenerateSvg = (text, w = 50, h = 70) => window.generateSvgThumbnail ? window.generateSvgThumbnail(text, w, h) : 'data:image/svg+xml...';
            const safeShowNotification = (msg, type) => window.showNotification ? window.showNotification(msg, type) : console.log(msg);
            const safeShowAlert = (msg, cb) => window.showAlertModal ? window.showAlertModal(msg, cb) : (alert(msg), cb?.());
            const safeShowConfirm = (msg, onConfirm, onCancel) => window.showConfirmModal ? window.showConfirmModal(msg, onConfirm, onCancel) : (confirm(msg) ? onConfirm?.() : onCancel?.());

            // ---------- –°–¢–ê–¢–ò–°–¢–ò–ö–ê ----------
            function loadStats() {
                const anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                let eps = 0;
                anime.forEach(a => eps += (a.videos?.length || 0));
                document.getElementById('totalAnime').textContent = anime.length;
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalEpisodes').textContent = eps;
            }

            // ---------- –°–ü–ò–°–û–ö –ê–ù–ò–ú–ï ----------
            function loadAnimeList() {
                const container = document.getElementById('animeList');
                if (!container) return;
                const anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                if (anime.length === 0) {
                    container.innerHTML = '<p style="color:#666;">–ê–Ω–∏–º–µ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    return;
                }
                container.innerHTML = anime.map(a => {
                    const thumb = a.image || safeGenerateSvg(a.title);
                    return `
                        <div class="admin-list-item">
                            <div class="item-info">
                                <img src="${thumb}" alt="${safeEscapeHtml(a.title)}" onerror="this.src='${safeGenerateSvg(a.title)}'">
                                <div>
                                    <strong>${safeEscapeHtml(a.title)}</strong>
                                    <span style="display:block; color:#666; font-size:0.9rem;">${a.episodes || 0} —Å–µ—Ä–∏–π ‚Ä¢ ${a.year || '?'}</span>
                                </div>
                            </div>
                            <div class="item-actions">
                                <button onclick="openEditModal(${a.id})" class="btn-small" style="background:#0984e3; color:white;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button onclick="openEpisodeModal(${a.id}, '${safeEscapeHtml(a.title).replace(/'/g, "\\'")}')" class="btn-small" style="background:#00b894; color:white;">üìπ –°–µ—Ä–∏–∏</button>
                                <button onclick="deleteAnime(${a.id})" class="btn-small btn-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // ---------- –£–î–ê–õ–ï–ù–ò–ï –ê–ù–ò–ú–ï ----------
            window.deleteAnime = function(id) {
                safeShowConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∞–Ω–∏–º–µ? –í—Å–µ —Å–µ—Ä–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.', async () => {
                    await initIndexedDB();
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const index = store.index('animeId');
                    index.getAllKeys(IDBKeyRange.only(id)).onsuccess = (e) => {
                        e.target.result.forEach(key => store.delete(key));
                    };
                    let anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                    anime = anime.filter(a => a.id !== id);
                    if (window.syncAnimeData) window.syncAnimeData(anime);
                    else localStorage.setItem('animeData', JSON.stringify(anime));
                    safeShowNotification('üóëÔ∏è –ê–Ω–∏–º–µ —É–¥–∞–ª–µ–Ω–æ');
                    loadStats(); loadAnimeList(); loadAnimeSelect(); loadRecentVideos();
                });
            };

            // ---------- –°–ï–õ–ï–ö–¢ –ê–ù–ò–ú–ï ----------
            function loadAnimeSelect() {
                const select = document.getElementById('animeSelect');
                if (!select) return;
                const anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                select.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∞–Ω–∏–º–µ ‚Äî</option>' + 
                    anime.map(a => `<option value="${a.id}">${safeEscapeHtml(a.title)}</option>`).join('');
            }

            // ---------- –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ï–†–ò–Ø–ú–ò ----------
            window.openEpisodeModal = async function(animeId, animeTitle) {
                document.getElementById('modalAnimeTitle').textContent = `–°–µ—Ä–∏–∏: ${animeTitle}`;
                const container = document.getElementById('episodeList');
                const anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                const a = anime.find(a => a.id === animeId);
                if (!a?.videos?.length) {
                    container.innerHTML = '<p style="color:#666;">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π</p>';
                } else {
                    container.innerHTML = a.videos
                        .sort((x,y) => x.episode - y.episode)
                        .map(v => {
                            const sources = v.sources || (v.url ? [{ url: v.url, type: v.type || 'url', id: v.id, quality: 'Auto' }] : []);
                            const qualities = sources.map(s => s.quality).join(', ');
                            return `
                                <div class="episode-item-admin">
                                    <span><strong>–°–µ—Ä–∏—è ${v.episode}</strong> (${qualities || 'SD'})</span>
                                    <button onclick="deleteEpisode(${animeId}, ${v.episode})" class="btn-episode-delete">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            `;
                        }).join('');
                }
                document.getElementById('episodeModal').classList.add('active');
            };

            window.closeEpisodeModal = function() {
                document.getElementById('episodeModal').classList.remove('active');
            };

            window.deleteEpisode = async function(animeId, episode) {
                safeShowConfirm(`–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–∏—é ${episode}?`, async () => {
                    let anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                    const a = anime.find(a => a.id === animeId);
                    if (a?.videos) {
                        const video = a.videos.find(v => v.episode === episode);
                        if (video?.sources) {
                            await initIndexedDB();
                            const tx = db.transaction(STORE_NAME, 'readwrite');
                            const store = tx.objectStore(STORE_NAME);
                            video.sources.forEach(s => { if (s.type === 'indexeddb' && s.id) store.delete(s.id); });
                        } else if (video?.type === 'indexeddb' && video.id) {
                            await initIndexedDB();
                            db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).delete(video.id);
                        }
                        a.videos = a.videos.filter(v => v.episode !== episode);
                        if (window.syncAnimeData) window.syncAnimeData(anime);
                        else localStorage.setItem('animeData', JSON.stringify(anime));
                        safeShowNotification(`üóëÔ∏è –°–µ—Ä–∏—è ${episode} —É–¥–∞–ª–µ–Ω–∞`);
                        loadStats(); loadRecentVideos();
                        if (document.getElementById('episodeModal').classList.contains('active')) {
                            openEpisodeModal(animeId, a.title);
                        }
                    }
                });
            };

            // ---------- –ü–û–°–õ–ï–î–ù–ò–ï –ó–ê–ì–†–£–ó–ö–ò ----------
            async function loadRecentVideos() {
                const container = document.getElementById('recentVideos');
                if (!container) return;
                const anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                const videos = [];
                await initIndexedDB();
                anime.forEach(a => {
                    if (a.videos) {
                        a.videos.forEach(v => {
                            videos.push({
                                animeId: a.id,
                                animeTitle: a.title,
                                episode: v.episode,
                                sources: v.sources || []
                            });
                        });
                    }
                });
                const recent = videos.slice(-10).reverse();
                container.innerHTML = recent.length ? recent.map(v => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:0.8rem; border-bottom:1px solid #eee;">
                        <span>
                            <strong>${safeEscapeHtml(v.animeTitle)}</strong> ‚Äî –°–µ—Ä–∏—è ${v.episode} (${v.sources.length} –≤–∞—Ä.)
                        </span>
                        <button onclick="deleteEpisode(${v.animeId}, ${v.episode})" class="btn-small" style="background:#ff7675; color:white;">üóëÔ∏è</button>
                    </div>
                `).join('') : '<p style="color:#666;">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π</p>';
            }

            // ---------- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –§–ê–ô–õ/–°–°–´–õ–ö–ê ----------
            const fileRadio = document.querySelector('input[value="file"]');
            const urlRadio = document.querySelector('input[value="url"]');
            const fileBlock = document.getElementById('fileUploadBlock');
            const urlBlock = document.getElementById('urlUploadBlock');
            if (fileRadio && urlRadio) {
                fileRadio.addEventListener('change', () => { fileBlock.style.display = 'block'; urlBlock.style.display = 'none'; });
                urlRadio.addEventListener('change', () => { fileBlock.style.display = 'none'; urlBlock.style.display = 'block'; });
            }

            // ---------- –°–û–•–†–ê–ù–ï–ù–ò–ï –§–ê–ô–õ–ê –í INDEXEDDB ----------
            async function saveFileToIndexedDB(file, animeId, episode, qualityLabel = 'SD') {
                await initIndexedDB();
                const id = `${animeId}_${episode}_${qualityLabel}_${Date.now()}`;
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                return new Promise((resolve, reject) => {
                    const request = store.put({
                        id,
                        animeId,
                        episode,
                        qualityLabel,
                        file,
                        name: file.name,
                        type: file.type,
                        size: file.size
                    });
                    request.onsuccess = () => resolve(id);
                    request.onerror = () => reject(request.error);
                });
            }

            // ---------- –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û ----------
            document.getElementById('addVideoForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const animeId = parseInt(document.getElementById('animeSelect').value);
                if (!animeId) { safeShowAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–Ω–∏–º–µ!'); return; }

                const episode = parseInt(document.getElementById('episode').value);
                if (!episode || episode < 1) { safeShowAlert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å–µ—Ä–∏–∏!'); return; }

                const useFile = document.querySelector('input[name="videoType"]:checked')?.value === 'file';

                if (useFile) {
                    const file = document.getElementById('videoFile').files[0];
                    if (!file) { safeShowAlert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ—Ñ–∞–π–ª!'); return; }
                    if (!file.type.includes('mp4') && !file.type.includes('webm')) {
                        safeShowAlert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ MP4 –∏ WebM!');
                        return;
                    }
                    if (file.size > 1024 * 1024 * 1024) {
                        safeShowAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 1 –ì–ë.');
                        return;
                    }

                    const progressBar = document.querySelector('.progress-bar');
                    const progressContainer = document.getElementById('uploadProgress');
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';

                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 5;
                        if (progress <= 90) progressBar.style.width = progress + '%';
                    }, 100);

                    try {
                        const videoId = await saveFileToIndexedDB(file, animeId, episode, 'SD');
                        clearInterval(interval);
                        progressBar.style.width = '100%';
                        setTimeout(() => { progressContainer.style.display = 'none'; }, 500);

                        let anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                        const a = anime.find(a => a.id === animeId);
                        if (a) {
                            if (!a.videos) a.videos = [];
                            a.videos = a.videos.filter(v => v.episode !== episode);
                            a.videos.push({
                                episode,
                                type: 'indexeddb',
                                id: videoId,
                                size: file.size
                            });
                            if (window.syncAnimeData) window.syncAnimeData(anime);
                            else localStorage.setItem('animeData', JSON.stringify(anime));
                            safeShowNotification(`‚úÖ –°–µ—Ä–∏—è ${episode} –∑–∞–≥—Ä—É–∂–µ–Ω–∞!`);

                            e.target.reset();
                            fileRadio.checked = true;
                            fileBlock.style.display = 'block';
                            urlBlock.style.display = 'none';
                            loadStats(); loadRecentVideos();
                        }
                    } catch (err) {
                        clearInterval(interval);
                        progressContainer.style.display = 'none';
                        safeShowAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ IndexedDB: ' + err.message);
                    }
                } else {
                    const url = document.getElementById('videoUrl').value.trim();
                    if (!url) { safeShowAlert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ!'); return; }

                    let anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                    const a = anime.find(a => a.id === animeId);
                    if (a) {
                        if (!a.videos) a.videos = [];
                        a.videos = a.videos.filter(v => v.episode !== episode);
                        a.videos.push({
                            episode,
                            type: 'url',
                            url
                        });
                        if (window.syncAnimeData) window.syncAnimeData(anime);
                        else localStorage.setItem('animeData', JSON.stringify(anime));
                        safeShowNotification(`‚úÖ –°–µ—Ä–∏—è ${episode} –¥–æ–±–∞–≤–ª–µ–Ω–∞ (—Å—Å—ã–ª–∫–∞)!`);
                        e.target.reset();
                        fileRadio.checked = true;
                        fileBlock.style.display = 'block';
                        urlBlock.style.display = 'none';
                        loadStats(); loadRecentVideos();
                    }
                }
            });

            // ---------- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ê–ù–ò–ú–ï ----------
            window.openEditModal = function(animeId) {
                const anime = JSON.parse(localStorage.getItem('animeData') || '[]').find(a => a.id === animeId);
                if (!anime) return;
                document.getElementById('editId').value = anime.id;
                document.getElementById('editTitle').value = anime.title || '';
                document.getElementById('editYear').value = anime.year || '';
                document.getElementById('editEpisodes').value = anime.episodes || 12;
                document.getElementById('editRating').value = anime.rating || '';
                document.getElementById('editDescription').value = anime.description || '';
                const editGenreSelect = document.getElementById('editGenre');
                const genres = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                editGenreSelect.innerHTML = genres.map(g => `<option value="${g}" ${g === anime.genre ? 'selected' : ''}>${g}</option>`).join('');
                document.getElementById('editAnimeModal').classList.add('active');
            };

            window.closeEditModal = function() {
                document.getElementById('editAnimeModal').classList.remove('active');
                document.getElementById('editImage').value = '';
            };

            document.getElementById('editAnimeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const id = parseInt(document.getElementById('editId').value);
                let animeData = JSON.parse(localStorage.getItem('animeData') || '[]');
                const index = animeData.findIndex(a => a.id === id);
                if (index === -1) return;

                const imageFile = document.getElementById('editImage').files[0];
                const processImage = imageFile ? new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageFile);
                }) : Promise.resolve(animeData[index].image);

                const imageDataUrl = await processImage;

                animeData[index] = {
                    ...animeData[index],
                    title: document.getElementById('editTitle').value.trim(),
                    genre: document.getElementById('editGenre').value,
                    year: parseInt(document.getElementById('editYear').value),
                    episodes: parseInt(document.getElementById('editEpisodes').value),
                    rating: parseFloat(document.getElementById('editRating').value) || 0,
                    description: document.getElementById('editDescription').value.trim(),
                    image: imageDataUrl
                };

                if (window.syncAnimeData) window.syncAnimeData(animeData);
                else localStorage.setItem('animeData', JSON.stringify(animeData));
                safeShowNotification('‚úÖ –ê–Ω–∏–º–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                closeEditModal();
                loadStats(); loadAnimeList(); loadAnimeSelect();
            });

            // ---------- –ñ–ê–ù–†–´ ----------
            function updateGenreSelects() {
                const genres = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                const addGenreSelect = document.getElementById('genre');
                if (addGenreSelect) addGenreSelect.innerHTML = genres.map(g => `<option value="${g}">${g}</option>`).join('');
                const editGenreSelect = document.getElementById('editGenre');
                if (editGenreSelect) {
                    const currentVal = editGenreSelect.value;
                    editGenreSelect.innerHTML = genres.map(g => `<option value="${g}" ${g === currentVal ? 'selected' : ''}>${g}</option>`).join('');
                }
            }

            function loadGenresList() {
                const container = document.getElementById('genresList');
                if (!container) return;
                const genres = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                const animeData = JSON.parse(localStorage.getItem('animeData') || '[]');
                container.innerHTML = genres.map(g => {
                    const count = animeData.filter(a => a.genre === g).length;
                    return `
                        <div class="genre-item">
                            <div class="genre-info">
                                <span class="genre-name">${safeEscapeHtml(g)}</span>
                                <span class="genre-count">${count} –∞–Ω–∏–º–µ</span>
                            </div>
                            <button onclick="deleteGenreHandler('${safeEscapeHtml(g).replace(/'/g, "\\'")}', ${count})" 
                                class="btn-small ${count > 0 ? 'btn-disabled' : 'btn-delete'}" ${count > 0 ? 'disabled' : ''}>
                                ${count > 0 ? 'üîí –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è' : 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å'}
                            </button>
                        </div>
                    `;
                }).join('');
            }

            window.deleteGenreHandler = function(genre, count) {
                if (count > 0) {
                    safeShowAlert(`–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∂–∞–Ω—Ä ¬´${genre}¬ª, –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ${count} –∞–Ω–∏–º–µ.`);
                    return;
                }
                safeShowConfirm(`–£–¥–∞–ª–∏—Ç—å –∂–∞–Ω—Ä ¬´${genre}¬ª?`, () => {
                    let genres = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                    genres = genres.filter(g => g !== genre);
                    localStorage.setItem('animeGenres', JSON.stringify(genres));
                    safeShowNotification(`üóëÔ∏è –ñ–∞–Ω—Ä ¬´${genre}¬ª —É–¥–∞–ª—ë–Ω`);
                    loadGenresList(); updateGenreSelects();
                    window.dispatchEvent(new Event('storage'));
                });
            };

            document.getElementById('addGenreBtn')?.addEventListener('click', () => {
                const input = document.getElementById('newGenre');
                const newGenre = input.value.trim().toLowerCase();
                if (!newGenre) { safeShowAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∂–∞–Ω—Ä–∞!'); return; }
                let genres = JSON.parse(localStorage.getItem('animeGenres') || '[]');
                if (genres.includes(newGenre)) { safeShowAlert('–¢–∞–∫–æ–π –∂–∞–Ω—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!'); return; }
                genres.push(newGenre); genres.sort();
                localStorage.setItem('animeGenres', JSON.stringify(genres));
                safeShowNotification(`‚úÖ –ñ–∞–Ω—Ä ¬´${newGenre}¬ª –¥–æ–±–∞–≤–ª–µ–Ω`);
                input.value = '';
                loadGenresList(); updateGenreSelects();
                window.dispatchEvent(new Event('storage'));
            });

            // ---------- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ----------
            function loadUsersList() {
                const container = document.getElementById('usersList');
                if (!container) return;
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                if (!users.length) {
                    container.innerHTML = '<p style="color:#666;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</p>';
                    return;
                }
                container.innerHTML = users.map(u => {
                    const avatarSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'%3E%3Ccircle cx='25' cy='25' r='25' fill='%236c5ce7'/%3E%3Ctext x='50%25' y='50%25' font-size='25' fill='white' text-anchor='middle' dy='.3em'%3E${encodeURIComponent(u.username.charAt(0).toUpperCase())}%3C/text%3E%3C/svg%3E`;
                    return `
                        <div class="user-card">
                            <div class="user-card-avatar"><img src="${avatarSvg}" alt="avatar"></div>
                            <div style="flex:1;">
                                <div style="display:flex; align-items:center; gap:0.5rem;">
                                    <strong>${safeEscapeHtml(u.username)}</strong>
                                    <span class="user-badge ${u.role === 'admin' ? 'admin' : ''}">${u.role === 'admin' ? '–ê–¥–º–∏–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
                                </div>
                                <div style="color:#666;">${safeEscapeHtml(u.email)}</div>
                            </div>
                            ${u.role !== 'admin' ? `<button onclick="makeAdmin(${u.id})" class="btn-small" style="background:#00b894; color:white;">üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>` : ''}
                        </div>
                    `;
                }).join('');

                const searchInput = document.getElementById('userSearch');
                if (searchInput) {
                    searchInput.oninput = (e) => {
                        const q = e.target.value.toLowerCase();
                        const filtered = users.filter(u => u.username.toLowerCase().includes(q) || u.email.toLowerCase().includes(q));
                        container.innerHTML = filtered.map(u => {
                            const avatarSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50' viewBox='0 0 50 50'%3E%3Ccircle cx='25' cy='25' r='25' fill='%236c5ce7'/%3E%3Ctext x='50%25' y='50%25' font-size='25' fill='white' text-anchor='middle' dy='.3em'%3E${encodeURIComponent(u.username.charAt(0).toUpperCase())}%3C/text%3E%3C/svg%3E`;
                            return `
                                <div class="user-card">
                                    <div class="user-card-avatar"><img src="${avatarSvg}" alt="avatar"></div>
                                    <div style="flex:1;">
                                        <div style="display:flex; align-items:center; gap:0.5rem;">
                                            <strong>${safeEscapeHtml(u.username)}</strong>
                                            <span class="user-badge ${u.role === 'admin' ? 'admin' : ''}">${u.role === 'admin' ? '–ê–¥–º–∏–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
                                        </div>
                                        <div style="color:#666;">${safeEscapeHtml(u.email)}</div>
                                    </div>
                                    ${u.role !== 'admin' ? `<button onclick="makeAdmin(${u.id})" class="btn-small" style="background:#00b894; color:white;">üëë</button>` : ''}
                                </div>
                            `;
                        }).join('');
                    };
                }
            }

            window.makeAdmin = function(id) {
                safeShowConfirm('–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?', () => {
                    let users = JSON.parse(localStorage.getItem('users') || '[]');
                    const u = users.find(u => u.id === id);
                    if (u) {
                        u.role = 'admin';
                        localStorage.setItem('users', JSON.stringify(users));
                        safeShowNotification('üëë –ê–¥–º–∏–Ω –Ω–∞–∑–Ω–∞—á–µ–Ω');
                        loadUsersList();
                    }
                });
            };

            // ---------- –î–û–ë–ê–í–õ–ï–ù–ò–ï –ê–ù–ò–ú–ï ----------
            document.getElementById('addAnimeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const title = document.getElementById('title').value.trim();
                if (!title) { safeShowAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!'); return; }
                const imageFile = document.getElementById('animeImage').files[0];
                const processImage = imageFile ? new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageFile);
                }) : Promise.resolve('');
                processImage.then(imageDataUrl => {
                    const newAnime = {
                        id: Date.now(),
                        title,
                        genre: document.getElementById('genre').value,
                        year: parseInt(document.getElementById('year').value) || new Date().getFullYear(),
                        episodes: parseInt(document.getElementById('episodes').value) || 12,
                        rating: parseFloat(document.getElementById('rating').value) || 0,
                        description: document.getElementById('description').value.trim() || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
                        image: imageDataUrl,
                        videos: []
                    };
                    let anime = JSON.parse(localStorage.getItem('animeData') || '[]');
                    anime.push(newAnime);
                    if (window.syncAnimeData) window.syncAnimeData(anime);
                    else localStorage.setItem('animeData', JSON.stringify(anime));
                    safeShowNotification('‚úÖ –ê–Ω–∏–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
                    e.target.reset();
                    loadStats(); loadAnimeList(); loadAnimeSelect();
                }).catch(err => safeShowAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + err.message));
            });

            // ---------- –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –í–ö–õ–ê–î–ö–ê–ú ----------
            const navLinks = document.querySelectorAll('.admin-nav a');
            const sections = document.querySelectorAll('.admin-section');

            function activateSection(targetId) {
                navLinks.forEach(l => l.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));
                const activeLink = Array.from(navLinks).find(l => l.getAttribute('href') === `#${targetId}`);
                if (activeLink) activeLink.classList.add('active');
                const activeSection = document.getElementById(targetId);
                if (activeSection) activeSection.classList.add('active');
                if (targetId === 'videos') { loadAnimeSelect(); loadRecentVideos(); }
                if (targetId === 'users') loadUsersList();
                if (targetId === 'genres') { loadGenresList(); updateGenreSelects(); }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    activateSection(link.getAttribute('href').substring(1));
                });
            });

            // ---------- –ë–£–†–ì–ï–† –ê–î–ú–ò–ù–ö–ò ----------
            const adminBurger = document.getElementById('adminBurgerBtn');
            const adminNav = document.querySelector('.admin-nav');
            const adminTheme = document.querySelector('.admin-theme-switcher');
            const adminLang = document.querySelector('.admin-language-switcher');
            if (adminBurger) {
                adminBurger.addEventListener('click', function() {
                    this.classList.toggle('active');
                    adminNav.classList.toggle('active');
                    adminTheme.classList.toggle('active');
                    adminLang.classList.toggle('active');
                });
            }

            // ---------- –í–´–•–û–î ----------
            document.getElementById('logoutBtn').addEventListener('click', () => {
                safeShowConfirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?', () => {
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                });
            });

            // ---------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ----------
            initIndexedDB().catch(console.error);
            loadStats();
            loadAnimeList();
            loadUsersList();
            loadAnimeSelect();
            loadRecentVideos();
            updateGenreSelects();
            if (document.getElementById('genres')?.classList.contains('active')) loadGenresList();

            const hash = window.location.hash.substring(1);
            if (hash && ['dashboard', 'anime', 'videos', 'genres', 'users'].includes(hash)) {
                activateSection(hash);
            }
        })();
    </script>
</body>
</html>