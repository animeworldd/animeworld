<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å - AnimeWorld</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="index.html"><h1>üç• AnimeWorld</h1></a>
            </div>
            <button class="burger-btn" id="burgerBtn">
                <span></span><span></span><span></span>
            </button>
            <div class="nav-links" id="navLinks">
                <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            </div>
            <div class="nav-controls">
                <div id="userMenu" class="user-menu"></div>
                <div class="theme-switcher">
                    <button class="theme-btn" data-theme="default" onclick="setTheme('default')">‚òÄÔ∏è</button>
                    <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">üåô</button>
                    <button class="theme-btn" data-theme="blue" onclick="setTheme('blue')">üîµ</button>
                    <button class="theme-btn" data-theme="purple" onclick="setTheme('purple')">üü£</button>
                    <button class="theme-btn" data-theme="cyberpunk" onclick="setTheme('cyberpunk')">ü§ñ</button>
                    <button class="theme-btn" data-theme="sunset" onclick="setTheme('sunset')">üåÖ</button>
                    <button class="theme-btn" data-theme="forest" onclick="setTheme('forest')">üå≤</button>
                </div>
                <button id="logoutBtn" style="padding:0.5rem 1rem; background:#ff7675; color:white; border:none; border-radius:20px;">–í—ã–π—Ç–∏</button>
            </div>
        </nav>
    </header>

    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar-wrapper">
                <div id="profileAvatar" class="profile-avatar">
                    <!-- –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
                </div>
                <button id="changeAvatarBtn" class="change-avatar-btn" title="–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä">üì∑</button>
            </div>
            <div>
                <h2 id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="email"></p>
                <span id="roleBadge" class="admin-badge" style="display:none;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <button id="tabInfoBtn" class="filter-btn active" style="flex:1;">üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
            <button id="tabFavoritesBtn" class="filter-btn" style="flex:1;">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
            <button id="tabThemesBtn" class="filter-btn" style="flex:1;">üé® –¢–µ–º—ã</button>
            <button id="tabStatsBtn" class="filter-btn" style="flex:1;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div id="tabInfo" class="tab-content" style="background:white; padding:2rem; border-radius:20px;">
            <h3>–ú–æ–∏ —Å–ø–∏—Å–∫–∏</h3>
            <div id="profileContent"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
        <div id="tabFavorites" class="tab-content" style="display: none; background:white; padding:2rem; border-radius:20px;">
            <h3>‚ù§Ô∏è –ú–æ–∏ –ª—é–±–∏–º—ã–µ –∞–Ω–∏–º–µ</h3>
            <div id="favoritesList" class="anime-grid" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –¢–µ–º—ã -->
        <div id="tabThemes" class="tab-content" style="display: none; background:white; padding:2rem; border-radius:20px;">
            <h3>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞</h3>
            <p style="color: var(--text-light); margin-bottom: 1rem;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è. –¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö.</p>
            <div class="theme-selector">
                <button class="theme-option" data-theme="default" onclick="setTheme('default')">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
                <button class="theme-option" data-theme="dark" onclick="setTheme('dark')">üåô –¢—ë–º–Ω–∞—è</button>
                <button class="theme-option" data-theme="blue" onclick="setTheme('blue')">üîµ –°–∏–Ω—è—è</button>
                <button class="theme-option" data-theme="purple" onclick="setTheme('purple')">üü£ –§–∏–æ–ª–µ—Ç–æ–≤–∞—è</button>
                <button class="theme-option" data-theme="cyberpunk" onclick="setTheme('cyberpunk')">ü§ñ –ö–∏–±–µ—Ä–ø–∞–Ω–∫</button>
                <button class="theme-option" data-theme="sunset" onclick="setTheme('sunset')">üåÖ –ó–∞–∫–∞—Ç</button>
                <button class="theme-option" data-theme="forest" onclick="setTheme('forest')">üå≤ –õ–µ—Å–Ω–∞—è</button>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="tabStats" class="tab-content" style="display: none; background:white; padding:2rem; border-radius:20px;">
            <h3>üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div id="statsContainer"></div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        (function() {
            "use strict";

            // ---------- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ----------
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // ---------- –û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ----------
            document.getElementById('username').textContent = user.username;
            document.getElementById('email').textContent = user.email;

            function updateAvatarDisplay() {
                const avatarDiv = document.getElementById('profileAvatar');
                if (user.avatar && user.avatar.startsWith('data:image')) {
                    avatarDiv.innerHTML = `<img src="${user.avatar}" alt="avatar">`;
                } else {
                    avatarDiv.innerHTML = `<span style="font-size: 3rem;">${user.avatar || 'üë§'}</span>`;
                }
            }
            updateAvatarDisplay();

            if (user.role === 'admin') {
                document.getElementById('roleBadge').style.display = 'inline-block';
                document.getElementById('profileContent').innerHTML = `
                    <p style="margin-bottom:1rem;">üëë –£ –≤–∞—Å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
                    <button onclick="window.location.href='admin-panel.html'" style="padding:0.8rem 2rem; background:#6c5ce7; color:white; border:none; border-radius:10px;">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
                `;
            } else {
                document.getElementById('profileContent').innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–Ω–∏–º–µ.</p>';
            }

            // ---------- –ò–ó–ë–†–ê–ù–ù–û–ï ----------
            function loadFavorites() {
                const container = document.getElementById('favoritesList');
                if (!container) return;
                const animeData = JSON.parse(localStorage.getItem('animeData') || '[]');
                const favAnime = animeData.filter(a => user.favorites && user.favorites.includes(a.id));
                if (favAnime.length === 0) {
                    container.innerHTML = '<p style="color: #666;">–í—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –∞–Ω–∏–º–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.</p>';
                    return;
                }
                container.innerHTML = favAnime.map(a => {
                    const imgSrc = a.image || window.generateSvgThumbnail?.(a.title) || 'https://via.placeholder.com/150x225?text=Anime';
                    return `
                        <div class="anime-card" onclick="window.location.href='video-player.html?id=${a.id}'">
                            <img src="${imgSrc}" alt="${window.escapeHtml?.(a.title) || a.title}" onerror="this.src='${window.generateSvgThumbnail?.(a.title) || 'https://via.placeholder.com/150x225?text=Anime'}'">
                            <div class="anime-info">
                                <h3>${window.escapeHtml?.(a.title) || a.title}</h3>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // ---------- –°–¢–ê–¢–ò–°–¢–ò–ö–ê ----------
            function loadStats() {
                const container = document.getElementById('statsContainer');
                if (!container) return;
                if (!user.history || user.history.length === 0) {
                    container.innerHTML = '<p style="color: #666;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∞–Ω–∏–º–µ, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∞—Å—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.</p>';
                    return;
                }

                const history = user.history;
                const uniqueAnime = new Set(history.map(h => h.animeId)).size;
                const totalEpisodes = history.length;
                const lastWatch = new Date(Math.max(...history.map(h => h.timestamp))).toLocaleDateString('ru-RU', { day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' });

                // –ñ–∞–Ω—Ä—ã
                const genreStats = {};
                history.forEach(h => genreStats[h.genre] = (genreStats[h.genre] || 0) + 1);
                const sortedGenres = Object.entries(genreStats).sort((a,b) => b[1] - a[1]).slice(0,5);

                // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 7 –¥–Ω–µ–π
                const last7Days = {};
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const key = `${d.getDate().toString().padStart(2,'0')}.${(d.getMonth()+1).toString().padStart(2,'0')}`;
                    last7Days[key] = 0;
                }
                history.forEach(h => {
                    const d = new Date(h.timestamp);
                    const key = `${d.getDate().toString().padStart(2,'0')}.${(d.getMonth()+1).toString().padStart(2,'0')}`;
                    if (last7Days.hasOwnProperty(key)) last7Days[key]++;
                });

                // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                const recent = history.slice(-5).reverse();

                let html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow);">
                            <div style="font-size: 2rem; color: var(--primary);">${uniqueAnime}</div>
                            <div style="color: var(--text-light);">–í—Å–µ–≥–æ —Ç–∞–π—Ç–ª–æ–≤</div>
                        </div>
                        <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow);">
                            <div style="font-size: 2rem; color: var(--primary);">${totalEpisodes}</div>
                            <div style="color: var(--text-light);">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ —Å–µ—Ä–∏–π</div>
                        </div>
                        <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow);">
                            <div style="font-size: 1.2rem; color: var(--primary);">${lastWatch}</div>
                            <div style="color: var(--text-light);">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ—Å–º–æ—Ç—Ä</div>
                        </div>
                    </div>
                `;

                if (sortedGenres.length > 0) {
                    html += `<h4 style="margin-top: 2rem; margin-bottom: 1rem;">üé≠ –õ—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã</h4>`;
                    html += `<div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">`;
                    sortedGenres.forEach(([genre, count], index) => {
                        const percent = Math.round((count / totalEpisodes) * 100);
                        const color = window.getGenreColor?.(index) || '#6c5ce7';
                        html += `
                            <div style="flex: 1; min-width: 150px; background: var(--card-bg); padding: 1rem; border-radius: 10px; box-shadow: var(--shadow);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">${genre.charAt(0).toUpperCase() + genre.slice(1)}</span>
                                    <span style="color: var(--primary);">${percent}%</span>
                                </div>
                                <div style="background: #f1f1f1; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${percent}%; height: 100%; background: ${color};"></div>
                                </div>
                                <div style="margin-top: 0.5rem; color: var(--text-light); font-size: 0.9rem;">${count} —Å–µ—Ä–∏–π</div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }

                html += `<h4 style="margin-top: 2rem; margin-bottom: 1rem;">üìÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h4>`;
                const maxCount = Math.max(...Object.values(last7Days), 1);
                html += `<div style="display: flex; align-items: flex-end; gap: 0.5rem; height: 150px; margin-bottom: 2rem;">`;
                Object.entries(last7Days).forEach(([day, count]) => {
                    const height = Math.max(20, (count / maxCount) * 100);
                    html += `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                            <div style="width: 100%; background: var(--primary); height: ${height}px; border-radius: 5px 5px 0 0; min-height: 20px;"></div>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem;">${day}</div>
                            <div style="font-size: 0.8rem; color: var(--primary);">${count}</div>
                        </div>
                    `;
                });
                html += `</div>`;

                html += `<h4 style="margin-top: 2rem; margin-bottom: 1rem;">‚è±Ô∏è –ù–µ–¥–∞–≤–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä—ã</h4>`;
                html += `<div style="display: flex; flex-direction: column; gap: 0.8rem;">`;
                recent.forEach(h => {
                    const timeAgo = window.formatTimeAgo?.(h.timestamp) || '–Ω–µ–¥–∞–≤–Ω–æ';
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: var(--card-bg); border-radius: 10px; box-shadow: var(--shadow);">
                            <div>
                                <strong>${window.escapeHtml?.(h.animeTitle) || h.animeTitle}</strong>
                                <span style="color: var(--text-light); margin-left: 0.5rem;">–°–µ—Ä–∏—è ${h.episode}</span>
                            </div>
                            <div style="color: var(--text-light); font-size: 0.9rem;">${timeAgo}</div>
                        </div>
                    `;
                });
                html += `</div>`;

                container.innerHTML = html;
            }

            // ---------- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö ----------
            const tabInfoBtn = document.getElementById('tabInfoBtn');
            const tabFavoritesBtn = document.getElementById('tabFavoritesBtn');
            const tabThemesBtn = document.getElementById('tabThemesBtn');
            const tabStatsBtn = document.getElementById('tabStatsBtn');
            const tabInfo = document.getElementById('tabInfo');
            const tabFavorites = document.getElementById('tabFavorites');
            const tabThemes = document.getElementById('tabThemes');
            const tabStats = document.getElementById('tabStats');

            function activateTab(tabName) {
                [tabInfo, tabFavorites, tabThemes, tabStats].forEach(t => t.style.display = 'none');
                [tabInfoBtn, tabFavoritesBtn, tabThemesBtn, tabStatsBtn].forEach(b => b.classList.remove('active'));

                if (tabName === 'info') {
                    tabInfo.style.display = 'block';
                    tabInfoBtn.classList.add('active');
                } else if (tabName === 'favorites') {
                    tabFavorites.style.display = 'block';
                    tabFavoritesBtn.classList.add('active');
                    loadFavorites();
                } else if (tabName === 'themes') {
                    tabThemes.style.display = 'block';
                    tabThemesBtn.classList.add('active');
                } else if (tabName === 'stats') {
                    tabStats.style.display = 'block';
                    tabStatsBtn.classList.add('active');
                    loadStats();
                }
            }

            tabInfoBtn.addEventListener('click', () => activateTab('info'));
            tabFavoritesBtn.addEventListener('click', () => activateTab('favorites'));
            tabThemesBtn.addEventListener('click', () => activateTab('themes'));
            tabStatsBtn.addEventListener('click', () => activateTab('stats'));

            // ---------- –°–ú–ï–ù–ê –ê–í–ê–¢–ê–†–ê ----------
            document.getElementById('changeAvatarBtn').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const imageData = event.target.result;
                            let users = JSON.parse(localStorage.getItem('users') || '[]');
                            const userIndex = users.findIndex(u => u.id === user.id);
                            if (userIndex !== -1) {
                                users[userIndex].avatar = imageData;
                                localStorage.setItem('users', JSON.stringify(users));
                                user.avatar = imageData;
                                localStorage.setItem('currentUser', JSON.stringify(user));
                                updateAvatarDisplay();
                                window.updateUserMenu?.();
                                window.showNotification?.('‚úÖ –ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            });

            // ---------- –í–´–•–û–î ----------
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });

            // ---------- –ê–ö–¢–ò–í–ù–ê–Ø –¢–ï–ú–ê ----------
            // —É–∂–µ –≤ setTheme / loadTheme
        })();
    </script>
</body>
</html>